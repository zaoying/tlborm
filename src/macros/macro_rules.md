# `macro_rules!`

æœ‰äº†è¿™äº›çŸ¥è¯†ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å¼•å…¥ `macro_rules!` äº†ã€‚
å¦‚å‰æ‰€è¿°ï¼Œ`macro_rules!` æœ¬èº«å°±æ˜¯ä¸€ä¸ªè¯­æ³•æ‰©å±•ï¼Œ
ä¹Ÿå°±æ˜¯è¯´å®ƒå¹¶ä¸æ˜¯ Rust è¯­æ³•çš„ä¸€éƒ¨åˆ†ã€‚å®ƒçš„å½¢å¼å¦‚ä¸‹ï¼š

```rust,ignore
macro_rules! $name {
    $rule0 ;
    $rule1 ;
    // â€¦
    $ruleN ;
}
```

*è‡³å°‘å¾—æœ‰ä¸€æ¡è§„åˆ™* (rule) ï¼Œæœ€åä¸€æ¡è§„åˆ™åé¢çš„åˆ†å·å¯è¢«çœç•¥ã€‚
è§„åˆ™é‡Œä½ å¯ä»¥ä½¿ç”¨å¤§/ä¸­/å°æ‹¬å·ï¼š`{}`ã€`[]`ã€`()`ã€‚
æ¯æ¡â€œè§„åˆ™â€éƒ½å½¢å¦‚ï¼š

```ignore
    ($matcher) => {$expansion}
```

å¦‚å‰æ‰€è¿°ï¼Œåˆ†ç»„ç¬¦å·å¯ä»¥æ˜¯ä»»æ„ä¸€ç§æ‹¬å·ï¼Œåœ¨æ¨¡å¼åŒ¹é…å¤–ä¾§ä½¿ç”¨å°æ‹¬å·ã€è¡¨è¾¾å¼å¤–ä¾§ä½¿ç”¨å¤§æ‹¬å·åªæ˜¯å‡ºäºä¼ ç»Ÿã€‚

æ³¨æ„ï¼šé€‰æ‹©å“ªç§æ‹¬å·å¹¶ä¸ä¼šå½±å“å®è¢«è°ƒç”¨ã€‚
äº‹å®ä¸Šï¼Œè°ƒç”¨å®æ—¶å¯ä»¥ä½¿ç”¨è¿™ä¸‰ç§ä¸­ä»»æ„ä¸€ç§æ‹¬å·ï¼Œåªä¸è¿‡ä½¿ç”¨ `{ ..  }` æˆ–è€… `( ...  );` 
çš„è¯ä¼šæœ‰æ‰€ä¸åŒï¼ˆå…³æ³¨ç‚¹åœ¨äºæœ«å°¾è·Ÿéšçš„åˆ†å· `;` ï¼‰ã€‚
æœ‰æœ«å°¾åˆ†å·çš„å®è°ƒç”¨ *æ€»æ˜¯* ä¼šè¢«è§£ææˆä¸€ä¸ªæ¡ç›® (item)ã€‚

å¦‚æœä½ å¥½å¥‡çš„è¯ï¼Œ`macro_rules!` çš„è°ƒç”¨å°†è¢«å±•å¼€ä¸º  *ç©º* (nothing) ã€‚
è‡³å°‘ï¼Œåœ¨ AST ä¸­å®ƒè¢«å±•å¼€ä¸ºç©ºã€‚
å®ƒæ‰€å½±å“çš„æ˜¯ç¼–è¯‘å™¨å†…éƒ¨çš„ç»“æ„ï¼Œä»¥å°†è¯¥å®æ³¨å†Œ (register) è¿›å»ã€‚
å› æ­¤ï¼ŒæŠ€æœ¯ä¸Šè®²ä½ å¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªç©ºå±•å¼€åˆæ³•çš„ä½ç½®ä½¿ç”¨ `macro_rules!` ã€‚

## æ¨¡å¼åŒ¹é…

å½“ä¸€ä¸ªå®è¢«è°ƒç”¨æ—¶ï¼Œå¯¹åº”çš„ `macro_rules!` è§£é‡Šå™¨å°†æŒ‰ç…§å£°æ˜é¡ºåºä¸€ä¸€æ£€æŸ¥è§„åˆ™ã€‚
å¯¹æ¯æ¡è§„åˆ™ï¼Œå®ƒéƒ½å°†å°è¯•å°†è¾“å…¥æ ‡è®°æ ‘çš„å†…å®¹ä¸è¯¥è§„åˆ™çš„è¿›è¡ŒåŒ¹é…ã€‚
æŸä¸ªæ¨¡å¼å¿…é¡»ä¸è¾“å…¥ *å®Œå…¨* åŒ¹é…æ‰è¢«è®¤ä¸ºæ˜¯ä¸€æ¬¡åŒ¹é…ã€‚ï¼ˆè¿™é‡Œæ‰€è¯‘â€œæ¨¡å¼â€çš„åŸè¯å« matcherï¼‰

å¦‚æœè¾“å…¥ä¸æŸä¸ªæ¨¡å¼ç›¸åŒ¹é…ï¼Œåˆ™è¯¥è°ƒç”¨é¡¹å°†è¢«ç›¸åº”çš„å±•å¼€å†…å®¹æ‰€å–ä»£ï¼›
å¦åˆ™ï¼Œå°†å°è¯•åŒ¹é…ä¸‹æ¡è§„åˆ™ã€‚
å¦‚æœæ‰€æœ‰è§„åˆ™å‡åŒ¹é…å¤±è´¥ï¼Œåˆ™å®å±•å¼€ä¼šå¤±è´¥å¹¶æŠ¥é”™ã€‚

æœ€ç®€å•çš„ä¾‹å­æ˜¯ç©ºæ¨¡å¼ï¼š

```rust,ignore
macro_rules! four {
    () => { 1 + 3 };
}
```

å®ƒå°†ä¸”ä»…å°†åŒ¹é…åˆ°ç©ºçš„è¾“å…¥ï¼Œå³ `four!()`ã€`four![]` æˆ– `four!{}` ã€‚

æ³¨æ„è°ƒç”¨æ‰€ç”¨çš„åˆ†ç»„æ ‡è®°å¹¶ *ä¸éœ€è¦* åŒ¹é…å®šä¹‰æ—¶é‡‡ç”¨çš„åˆ†ç»„æ ‡è®°ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥é€šè¿‡ `four![]` è°ƒç”¨ä¸Šè¿°å®ï¼Œæ­¤è°ƒç”¨ä»å°†è¢«è§†ä½œåŒ¹é…ã€‚
åªæœ‰è°ƒç”¨æ—¶çš„è¾“å…¥å†…å®¹æ‰ä¼šè¢«çº³å…¥åŒ¹é…è€ƒé‡èŒƒå›´ã€‚

æ¨¡å¼ä¸­ä¹Ÿå¯ä»¥åŒ…å«å­—é¢å€¼ (literal) æ ‡è®°æ ‘ï¼Œè¿™äº›æ ‡è®°æ ‘å¿…é¡»è¢«å®Œå…¨åŒ¹é…ã€‚
å°†æ•´ä¸ªå¯¹åº”æ ‡è®°æ ‘åœ¨ç›¸åº”ä½ç½®å†™ä¸‹å³å¯ã€‚
æ¯”å¦‚ï¼Œä¸ºåŒ¹é…æ ‡è®°åºåˆ— `4 fn ['spang "whammo"] @_@` ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š

```rust,ignore
macro_rules! gibberish {
    (4 fn ['spang "whammo"] @_@) => {...};
}
```

ä½¿ç”¨ `gibberish!(4 fn ['spang "whammo"] @_@'])` å³å¯æˆåŠŸåŒ¹é…å’Œè°ƒç”¨ã€‚

ä½ å¯ä»¥ä½¿ç”¨èƒ½å†™å‡ºçš„ä»»ä½•æ ‡è®°æ ‘ã€‚

## å…ƒå˜é‡ (Metavariables)

æ¨¡å¼ (macther) è¿˜å¯ä»¥åŒ…å«æ•è·ã€‚
å³åŸºäºæŸç§é€šç”¨è¯­æ³•æ¥åŒ¹é…è¾“å…¥ç±»åˆ«ï¼Œå¹¶å°†ç»“æœæ•è·åˆ°å…ƒå˜é‡ä¸­ï¼Œç„¶åå°†å…¶æ›¿æ¢åˆ°è¾“å‡ºä¸­ã€‚

æ•è·ä»¥ç¾å…ƒï¼ˆ`$`ï¼‰å½¢å¼å†™å…¥ï¼Œå…¶åè·Ÿæ ‡è¯†ç¬¦ å†’å·ï¼ˆ`:`ï¼‰ï¼Œæœ€åæ˜¯æ•è·ç±»å‹ï¼Œ
ä¹Ÿç§°ä¸º **ç‰‡æ®µåˆ†ç±»ç¬¦** ([fragment-specifier](https://doc.rust-lang.org/nightly/reference/macros-by-example.html#metavariables))ï¼Œ
ç‰‡æ®µåˆ†ç±»ç¬¦å¿…é¡»æ˜¯ä»¥ä¸‹ç±»å‹ä¹‹ä¸€ï¼š

* `block` å—ï¼šæ¯”å¦‚ç”¨å¤§æ‹¬å·åŒ…å›´èµ·æ¥çš„è¯­å¥å’Œ/æˆ–è¡¨è¾¾å¼
* `expr` è¡¨è¾¾å¼ (expression)
* `ident` æ ‡è¯†ç¬¦ (identifier)ï¼šåŒ…æ‹¬å…³é”®å­— (keywords)
* `item` æ¡ç›®ï¼šæ¯”å¦‚å‡½æ•°ã€ç»“æ„ä½“ã€æ¨¡å—ã€`impl` å—
* `lifetime` ç”Ÿå‘½å‘¨æœŸæ³¨è§£ï¼šæ¯”å¦‚ `'foo`ã€`'static`
* `literal` å­—é¢å€¼ï¼šæ¯”å¦‚ `"Hello World!"`ã€`3.14`ã€`'ğŸ¦€'`
* `meta` å…ƒä¿¡æ¯ï¼šæŒ‡ `#[...]` å’Œ `#![...]` å±æ€§å†…éƒ¨çš„å…ƒä¿¡æ¯æ¡ç›®
* `pat` æ¨¡å¼ (pattern)
* `path` è·¯å¾„ï¼šæ¯”å¦‚ `foo`ã€`::std::mem::replace`ã€`transmute::<_, int>`
* `stmt` è¯­å¥ (statement)
* `tt`ï¼šå•æ£µæ ‡è®°æ ‘ (single token tree)
* `ty` ç±»å‹
* `vis` å¯è§†æ ‡è¯†ç¬¦ï¼šå¯èƒ½ä¸ºç©ºçš„å¯è§†æ ‡è¯†ç¬¦ï¼Œæ¯”å¦‚ `pub`ã€`pub(in crate)`

å…³äºç‰‡æ®µåˆ†ç±»ç¬¦æ›´æ·±å…¥çš„æè¿°è¯·é˜…è¯» [ç‰‡æ®µåˆ†ç±»ç¬¦](./minutiae/fragment-specifiers.md) ç« ã€‚

æ¯”å¦‚ä»¥ä¸‹ `macro_rules!` å®æ•è·ä¸€ä¸ªè¡¨è¾¾å¼è¾“å…¥ï¼Œå¹¶ç»‘å®šç»™å…ƒå˜é‡ `$e`ï¼š

```rust,ignore
macro_rules! one_expression {
    ($e:expr) => {...};
}
```

å…ƒå˜é‡å¯¹ Rust ç¼–è¯‘å™¨çš„è§£æå™¨äº§ç”Ÿå½±å“ï¼Œä½¿å¾—å…ƒå˜é‡æ€»æ˜¯â€œæ­£ç¡®æ— è¯¯â€ã€‚
`expr` è¡¨è¾¾å¼å…ƒå˜é‡æ€»æ˜¯æ•è·å®Œæ•´ä¸”ç¬¦åˆ Rust ç¼–è¯‘ç‰ˆæœ¬çš„è¡¨è¾¾å¼ã€‚

ä½ å¯ä»¥åœ¨æœ‰é™çš„æ¡ä»¶å†…åŒæ—¶ç»“åˆå­—é¢å€¼æ ‡è®°æ ‘å’Œå…ƒå˜é‡ã€‚

å½“å…ƒå˜é‡è¢«æ˜ç¡®åŒ¹é…åˆ°çš„æ—¶å€™ï¼Œåªéœ€è¦å†™ `$name` å°±èƒ½å¼•ç”¨å…ƒå˜é‡çš„å€¼ã€‚æ¯”å¦‚ï¼š

```rust,ignore
macro_rules! times_five {
    ($e:expr) => { 5 * $e };
}
```

å…ƒå˜é‡è¢«æ›¿æ¢æˆå®Œæ•´çš„ AST èŠ‚ç‚¹ï¼Œè¿™å¾ˆåƒå®å±•å¼€ã€‚è¿™ä¹Ÿæ„å‘³ç€è¢« `$e` æ•è·çš„ä»»ä½•æ ‡è®°åºåˆ—éƒ½ä¼šè¢«è§£ææˆå•ä¸ªå®Œæ•´çš„è¡¨è¾¾å¼ã€‚

ä½ ä¹Ÿå¯ä»¥ä¸€ä¸ªæ¨¡å¼åŒ¹é…ä¸­ä½¿ç”¨å¤šä¸ªå…ƒå˜é‡ï¼š

```rust,ignore
macro_rules! multiply_add {
    ($a:expr, $b:expr, $c:expr) => { $a * ($b + $c) };
}
```

ç„¶ååœ¨å±•å¼€çš„åœ°æ–¹ï¼ˆæŒ‡ `=>` åˆ° `;` ä¹‹é—´ï¼‰ä½¿ç”¨ä»»æ„å¤šçš„å…ƒå˜é‡ï¼š

```rust,ignore
macro_rules! discard {
    ($e:expr) => {};
}
macro_rules! repeat {
    ($e:expr) => { $e; $e; $e; };
}
```

æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å®å˜é‡å«åš [`$crate`] ï¼Œå®ƒç”¨æ¥æŒ‡ä»£å½“å‰ crate ã€‚

[`$crate`]:./minutiae/hygiene.html#crate

## åå¤æ•è· (Repetitions)

æ¨¡å¼åŒ¹é…å¯ä»¥é‡å¤ã€‚è¿™ä½¿å¾—åŒ¹é…ä¸€è¿ä¸²æ ‡è®° (token) æˆä¸ºå¯èƒ½ã€‚åå¤æ•è·çš„ä¸€èˆ¬å½¢å¼ä¸º `$ ( ...  ) sep rep` ã€‚

ï¼ˆè¯‘è€…æ³¨ï¼šæˆ‘æ›´å€¾å‘äºä½¿ç”¨ â€œåå¤â€ ä½œä¸ºåŠ¨è¯ï¼Œä½¿ç”¨ â€œé‡å¤â€œ ä½œä¸ºåè¯å’Œå½¢å®¹è¯ï¼‰

* `$` æ˜¯å­—é¢ä¸Šçš„ç¾å…ƒç¬¦å·æ ‡è®°
* `( ... )` æ˜¯è¢«åå¤åŒ¹é…çš„æ¨¡å¼ï¼Œç”±å°æ‹¬å·åŒ…å›´ã€‚
* `sep` æ˜¯ **å¯é€‰** çš„åˆ†éš”æ ‡è®°ã€‚å®ƒä¸èƒ½æ˜¯æ‹¬å·æˆ–è€…é‡å¤æ“ä½œç¬¦ã€‚å¸¸ç”¨ä¾‹å­åŒ…æ‹¬ `,` å’Œ `;` ã€‚
* `rep` æ˜¯ **å¿…é¡»** çš„é‡å¤æ“ä½œç¬¦ã€‚å½“å‰å¯ä»¥æ˜¯ï¼š
    * `?`ï¼šè¡¨ç¤º æœ€å¤šä¸€æ¬¡é‡å¤ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨äºåˆ†å‰²æ ‡è®°ã€‚
    * `*`ï¼šè¡¨ç¤º é›¶æ¬¡æˆ–å¤šæ¬¡é‡å¤ã€‚
    * `+`ï¼šè¡¨ç¤º ä¸€æ¬¡æˆ–å¤šæ¬¡é‡å¤ã€‚

é‡å¤ä¸­å¯ä»¥åŒ…å«ä»»æ„æœ‰æ•ˆæ¨¡å¼ï¼ŒåŒ…æ‹¬å­—é¢æ ‡è®°æ ‘ã€å…ƒå˜é‡ä»¥åŠä»»æ„åµŒå¥—çš„é‡å¤ã€‚

åœ¨å±•å¼€çš„åœ°æ–¹ï¼ˆæŒ‡ `=>` åˆ° `;` ä¹‹é—´ï¼‰ï¼Œé‡å¤ä¹Ÿé‡‡ç”¨ç›¸åŒçš„è¯­æ³•ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œä¸‹é¢è¿™ä¸ªå®å°†æ¯ä¸€ä¸ªå…ƒç´ éƒ½è½¬æ¢æˆå­—ç¬¦ä¸²ã€‚
å®ƒå°†åŒ¹é…é›¶æˆ–å¤šä¸ªç”±é€—å·åˆ†éš”çš„è¡¨è¾¾å¼ï¼Œå¹¶åˆ†åˆ«å°†å®ƒä»¬æ‹“å±•æˆæ„é€  `Vec` çš„è¡¨è¾¾å¼ã€‚

```rust,editable
macro_rules! vec_strs {
    (
        // Start a repetition:
        $(
            // Each repeat must contain an expression...
            $element:expr
        )
        // ...separated by commas...
        ,
        // ...zero or more times.
        *
    ) => {
        // Enclose the expansion in a block so that we can use
        // multiple statements.
        {
            let mut v = Vec::new();

            // Start a repetition:
            $(
                // Each repeat will contain the following statement, with
                // $element replaced with the corresponding expression.
                v.push(format!("{}", $element));
            )*

            v
        }
    };
}

fn main() {
    let s = vec_strs![1, "a", true, 3.14159f32];
    assert_eq!(s, &["1", "a", "true", "3.14159"]);
}
```

ä½ å¯ä»¥åœ¨ä¸€ä¸ªé‡å¤è¯­å¥é‡Œé¢ä½¿ç”¨å¤šæ¬¡å’Œå¤šä¸ªå…ƒå˜é‡ï¼Œåªè¦è¿™äº›å…ƒå˜é‡ä»¥ç›¸åŒçš„æ¬¡æ•°é‡å¤ã€‚
ä¸‹é¢çš„å®å’Œè°ƒç”¨ä»£ç æ­£å¸¸è¿è¡Œï¼š

```rust,editable
macro_rules! repeat_two {
    ($($i:ident)*, $($i2:ident)*) => {
        $( let $i: (); let $i2: (); )*
    }
}

repeat_two!( a b c d e f, u v w x y z );
```

ä½†æ˜¯è¿™ä¸‹é¢çš„ä¸èƒ½è¿è¡Œï¼š

```rust,editable
# macro_rules! repeat_two {
#     ($($i:ident)*, $($i2:ident)*) => {
#         $( let $i: (); let $i2: (); )*
#     }
# }

repeat_two!( a b c d e f, x y z );
```

è¿è¡ŒæŠ¥ä»¥ä¸‹é”™è¯¯ï¼š

```
error: meta-variable `i` repeats 6 times, but `i2` repeats 3 times
 --> src/main.rs:6:10
  |
6 |         $( let $i: (); let $i2: (); )*
  |          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
```

&nbsp;

æƒ³äº†è§£å®Œæ•´çš„å®šä¹‰è¯­æ³•ï¼Œå¯ä»¥å‚è€ƒ Rust Reference ä¹¦çš„
[Macros By Example](https://doc.rust-lang.org/reference/macros-by-example.html#macros-by-example)
ä¸€ç« ã€‚
