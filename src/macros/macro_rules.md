# æ€è·¯ä»‹ç»

è¿™ä¸€èŠ‚ä¼šä»‹ç» Rust çš„[å£°æ˜å®ç³»ç»Ÿ][mbe]ï¼Œè§£é‡Šè¯¥ç³»ç»Ÿå¦‚ä½•ä½œä¸ºæ•´ä½“è¿ä½œã€‚

é¦–å…ˆä¼šæ·±å…¥æ„é€ è¯­æ³•åŠå…¶å…³é”®éƒ¨åˆ†ï¼Œç„¶åä»‹ç»ä½ è‡³å°‘åº”è¯¥äº†è§£çš„é€šç”¨ä¿¡æ¯ã€‚

[mbe]: https://doc.rust-lang.org/reference/macros-by-example.html

# `macro_rules!`

æœ‰äº†å‰è¿°çŸ¥è¯†ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥ä»‹ç» `macro_rules!` äº†ã€‚å¦‚å‰æ‰€è¿°ï¼Œ`macro_rules!`
æœ¬èº«å°±æ˜¯ä¸€ä¸ªè¯­æ³•æ‰©å±•ï¼Œä¹Ÿå°±æ˜¯ä»æŠ€æœ¯ä¸Šè¯´ï¼Œå®ƒå¹¶ä¸æ˜¯ Rust è¯­æ³•çš„ä¸€éƒ¨åˆ†ã€‚å®ƒçš„å½¢å¼å¦‚ä¸‹ï¼š

```rust,ignore
macro_rules! $name {
    $rule0 ;
    $rule1 ;
    // â€¦
    $ruleN ;
}
```

**è‡³å°‘å¾—æœ‰ä¸€æ¡è§„åˆ™**ï¼Œè€Œä¸”æœ€åä¸€æ¡è§„åˆ™åé¢çš„åˆ†å·å¯è¢«çœç•¥ã€‚è§„åˆ™é‡Œä½ å¯ä»¥ä½¿ç”¨å¤§/ä¸­/å°æ‹¬å·ï¼š
`{}`ã€`[]`ã€`()`[^braces]ã€‚æ¯æ¡â€œè§„åˆ™â€éƒ½å½¢å¦‚ï¼š

```ignore
    ($matcher) => {$expansion}
```

[^braces]: è¯‘è€…æ³¨ï¼šå®ƒä»¬çš„è‹±æ–‡åç§°æœ‰æ—¶å€™å¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœä½ ä¸è®¤è¯†è‹±æ–‡åç§°çš„è¯ï¼Œä¼šæ¯”è¾ƒéš¾è¯»æ‡‚æ–‡æ¡£ï¼ˆæ¯”å¦‚
           [`syn`]ï¼‰ã€‚braces `{}`ã€brackets `[]`ã€parentheses `()`ã€‚

[`syn`]: https://docs.rs/syn/latest/syn/token/index.html#parsing

åˆ†ç»„ç¬¦å·å¯ä»¥æ˜¯ä»»æ„ä¸€ç§æ‹¬å·ï¼Œä½†å¤„äºä¹ æƒ¯ï¼Œåœ¨æ¨¡å¼åŒ¹é… (matcher) å¤–ä¾§ä½¿ç”¨å°æ‹¬å·ã€å±•å¼€ 
(expansion ä¹Ÿå¯ä»¥å«åš transcriber) å¤–ä¾§ä½¿ç”¨å¤§æ‹¬å·ã€‚

æ³¨æ„ï¼šåœ¨è§„åˆ™é‡Œé€‰æ‹©å“ªç§æ‹¬å·å¹¶ä¸ä¼šå½±å“å®è°ƒç”¨ã€‚

è€Œä¸”ï¼Œå®é™…ä¸Šï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è°ƒç”¨å®æ—¶ä½¿ç”¨è¿™ä¸‰ç§ä¸­ä»»æ„ä¸€ç§æ‹¬å·ï¼Œåªä¸è¿‡ä½¿ç”¨ `{ ... }` æˆ–è€… `( ... );` 
çš„è¯ä¼šæœ‰æ‰€ä¸åŒï¼ˆå…³æ³¨ç‚¹åœ¨äºæœ«å°¾è·Ÿéšçš„åˆ†å· `;` ï¼‰ã€‚æœ‰æœ«å°¾åˆ†å·çš„å®è°ƒç”¨**æ€»æ˜¯**ä¼šè¢«è§£ææˆä¸€ä¸ªæ¡ç›® (item)ã€‚

å¦‚æœä½ å¥½å¥‡çš„è¯ï¼Œ`macro_rules!` çš„è°ƒç”¨å°†è¢«å±•å¼€æˆä»€ä¹ˆï¼Ÿç­”æ¡ˆæ˜¯ï¼šç©º (nothing)ã€‚è‡³å°‘ï¼Œåœ¨ AST
ä¸­å®ƒè¢«å±•å¼€ä¸ºç©ºã€‚å®ƒæ‰€å½±å“çš„æ˜¯ç¼–è¯‘å™¨å†…éƒ¨çš„ç»“æ„ï¼Œä»¥å°†è¯¥å®æ³¨å†Œ (register) 
è¿›å»ã€‚å› æ­¤ï¼ŒæŠ€æœ¯ä¸Šè®²ä½ å¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªç©ºå±•å¼€åˆæ³•çš„ä½ç½®ä½¿ç”¨ `macro_rules!`ã€‚

> è¯‘è€…æ³¨ï¼šè¿™é‡Œæåˆ°ä¸¤ç§æƒ…å†µï¼Œå®šä¹‰å£°æ˜å®å’Œä½¿ç”¨ï¼ˆæˆ–è€…è¯´è°ƒç”¨ï¼‰å£°æ˜å®ã€‚è€Œä¸”ï¼Œåœ¨æ‹¬å·çš„é€‰å–ä¸Šï¼š
> 1. å®šä¹‰çš„è§„åˆ™ä¸å…³å¿ƒ `($matcher) => {$expansion}` ä¸­çš„**å¤–å±‚**æ‹¬å·ç±»å‹ï¼Œä½† matcher å’Œ expansion
>    ä¹‹å†…çš„æ‹¬å·å±äºåŒ¹é…å’Œå±•å¼€çš„å†…å®¹ï¼Œæ‰€ä»¥å®ƒä»¬å†…éƒ¨ä½¿ç”¨ä»€ä¹ˆæ‹¬å·å–å†³äºä½ éœ€è¦ä»€ä¹ˆè¯­æ³•ã€‚
> 2. å‡å¦‚ä½¿ç”¨ `m!` è¿™ä¸ªå®ï¼Œå¦‚æœè¯¥å®å±•å¼€æˆæ¡ç›®ï¼Œåˆ™å¿…é¡»ä½¿ç”¨ `m! { ... }` æˆ–è€… `m!( ... );`ï¼›
>    å¦‚æœè¯¥å®å±•å¼€æˆè¡¨è¾¾å¼ï¼Œä½ å¯ä»¥ä½¿ç”¨ `m! { ... }` æˆ–è€… `m!( ... )` æˆ–è€… `m![ ... ]`ã€‚
> 3. å®é™…ä¸Šï¼Œå®šä¹‰å®çš„æ‹¬å·éµå¾ªä¹ æƒ¯å°±å¥½ï¼Œè€Œä½¿ç”¨å®çš„æ‹¬å·ç”¨é”™çš„è¯ï¼Œåªéœ€ä»”ç»†é˜…è¯»ç¼–è¯‘å™¨ç»™ä½ çš„é”™è¯¯ä¿¡æ¯ï¼Œå’Œä»¥ä¸Šç¬¬
>    2 ç‚¹ï¼Œå°±çŸ¥é“æ€ä¹ˆæ”¹äº†ã€‚

## åŒ¹é…

å½“ä¸€ä¸ªå®è¢«è°ƒç”¨æ—¶ï¼Œ`macro_rules!` è§£é‡Šå™¨å°†æŒ‰ç…§å£°æ˜é¡ºåºä¸€ä¸€æ£€æŸ¥è§„åˆ™ã€‚

å¯¹æ¯æ¡è§„åˆ™ï¼Œå®ƒéƒ½å°†å°è¯•å°†è¾“å…¥æ ‡è®°æ ‘çš„å†…å®¹ä¸è¯¥è§„åˆ™çš„ `matcher` è¿›è¡ŒåŒ¹é…ã€‚æŸä¸ª matcher [^matcher]
å¿…é¡»ä¸è¾“å…¥**å®Œå…¨**åŒ¹é…æ‰è¢«è®¤ä¸ºæ˜¯ä¸€æ¬¡åŒ¹é…ã€‚

[^matcher]: è¯‘è€…æ³¨ï¼šä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä¸ç¿»è¯‘ matcher è¿™ä¸ªæœ¯è¯­ï¼Œå®ƒæŒ‡çš„æ˜¯è¢«åŒ¹é…çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å£°æ˜å®è§„åˆ™çš„å‰åŠæ®µã€‚

å¦‚æœè¾“å…¥ä¸æŸä¸ª matcher ç›¸åŒ¹é…ï¼Œåˆ™è¯¥è°ƒç”¨å°†æ›¿æ¢æˆç›¸åº”çš„å±•å¼€å†…å®¹ (`expansion`) ï¼›å¦åˆ™ï¼Œå°†å°è¯•åŒ¹é…ä¸‹æ¡è§„åˆ™ã€‚

å¦‚æœæ‰€æœ‰è§„åˆ™å‡åŒ¹é…å¤±è´¥ï¼Œåˆ™å®å±•å¼€å¤±è´¥å¹¶æŠ¥é”™ã€‚

æœ€ç®€å•çš„ä¾‹å­æ˜¯ç©º matcherï¼š

```rust,ignore
macro_rules! four {
    () => { 1 + 3 };
}
```

å½“ä¸”ä»…å½“åŒ¹é…åˆ°ç©ºçš„è¾“å…¥æ—¶ï¼ŒåŒ¹é…æˆåŠŸï¼Œå³ `four!()`ã€`four![]` æˆ– `four!{}` ä¸‰ç§æ–¹å¼è°ƒç”¨æ˜¯åŒ¹é…æˆåŠŸçš„ ã€‚

æ³¨æ„æ‰€ç”¨çš„åˆ†ç»„æ ‡è®°å¹¶**ä¸éœ€è¦**åŒ¹é…å®šä¹‰æ—¶é‡‡ç”¨çš„åˆ†ç»„æ ‡è®°ï¼Œå› ä¸ºå®é™…ä¸Šåˆ†ç»„æ ‡è®°å¹¶æœªä¼ ç»™è°ƒç”¨ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥é€šè¿‡ `four![]` è°ƒç”¨ä¸Šè¿°å®ï¼Œæ­¤è°ƒç”¨ä»å°†è¢«è§†ä½œåŒ¹é…æˆåŠŸã€‚åªæœ‰è¾“å…¥çš„å†…å®¹æ‰ä¼šè¢«çº³å…¥åŒ¹é…è€ƒé‡èŒƒå›´ã€‚

matcher ä¸­ä¹Ÿå¯ä»¥åŒ…å«å­—é¢ä¸Š[^literal]çš„æ ‡è®°æ ‘ï¼Œè¿™äº›æ ‡è®°æ ‘å¿…é¡»è¢«å®Œå…¨åŒ¹é…ã€‚å°†æ•´ä¸ªå¯¹åº”æ ‡è®°æ ‘åœ¨ç›¸åº”ä½ç½®å†™ä¸‹å³å¯ã€‚

æ¯”å¦‚ï¼Œè¦åŒ¹é…æ ‡è®°åºåˆ— `4 fn ['spang "whammo"] @_@` ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š

```rust,ignore
macro_rules! gibberish {
    (4 fn ['spang "whammo"] @_@) => {...};
}
```

ä½¿ç”¨ `gibberish!(4 fn ['spang "whammo"] @_@'])` å³å¯æˆåŠŸåŒ¹é…å’Œè°ƒç”¨ã€‚

ä½ èƒ½å†™å‡ºä»€ä¹ˆæ ‡è®°æ ‘ï¼Œå°±å¯ä»¥ä½¿ç”¨ä»€ä¹ˆæ ‡è®°æ ‘ã€‚

[^literal]: è¯‘è€…æ³¨ï¼šè¿™é‡Œä¸æ˜¯æŒ‡ Rust çš„â€œå­—é¢å€¼â€ï¼Œè€Œæ˜¯æŒ‡ä¸è€ƒè™‘å«ä¹‰çš„æ ‡è®°ï¼Œæ¯”å¦‚è¿™ä¸ªä¾‹å­ä¸­ `fn` å’Œ `[]`éƒ½ä¸æ˜¯ 
            Rust çš„ [literal] æ ‡è®° ([token])ï¼Œè€Œæ˜¯ [keyword] å’Œ [delimiter] 
            æ ‡è®°ï¼Œæˆ–è€…ä»ä¸‹é¢è°ˆåˆ°çš„å…ƒå˜é‡è§’åº¦çœ‹ï¼Œå®ƒä»¬**å¯ä»¥**è¢« `ident` æˆ–è€… `tt` åˆ†ç±»ç¬¦æ•è·ã€‚

[literal]: https://doc.rust-lang.org/reference/tokens.html#literals
[token]: https://doc.rust-lang.org/reference/tokens.html
[delimiter]: https://doc.rust-lang.org/reference/tokens.html#delimiters
[keyword]: https://doc.rust-lang.org/reference/keywords.html

## å…ƒå˜é‡

matcher è¿˜å¯ä»¥åŒ…å«æ•è· (captures)ã€‚å³åŸºäºæŸç§é€šç”¨è¯­æ³•ç±»åˆ«æ¥åŒ¹é…è¾“å…¥ï¼Œå¹¶å°†ç»“æœæ•è·åˆ°å…ƒå˜é‡ (metavariable)
ä¸­ï¼Œç„¶åå°†æ›¿æ¢å…ƒå˜é‡åˆ°è¾“å‡ºã€‚

æ•è·çš„ä¹¦å†™æ–¹å¼æ˜¯ï¼šå…ˆå†™ç¾å…ƒç¬¦å· `$`ï¼Œç„¶åè·Ÿä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œç„¶åæ˜¯å†’å· `:`ï¼Œæœ€åæ˜¯æ•è·æ–¹å¼ï¼Œæ¯”å¦‚ `$e:expr`ã€‚

æ•è·æ–¹å¼åˆè¢«ç§°ä½œâ€œç‰‡æ®µåˆ†ç±»ç¬¦â€ ([fragment-specifier])ï¼Œå¿…é¡»æ˜¯ä»¥ä¸‹ä¸€ç§ï¼š

* [`block`](./minutiae/fragment-specifiers.md#block)ï¼šä¸€ä¸ªå—ï¼ˆæ¯”å¦‚ä¸€å—è¯­å¥æˆ–è€…ç”±å¤§æ‹¬å·åŒ…å›´çš„ä¸€ä¸ªè¡¨è¾¾å¼ï¼‰
* [`expr`](./minutiae/fragment-specifiers.md#expr)ï¼šä¸€ä¸ªè¡¨è¾¾å¼ (expression)
* [`ident`](./minutiae/fragment-specifiers.md#ident)ï¼šä¸€ä¸ªæ ‡è¯†ç¬¦ (identifier)ï¼ŒåŒ…æ‹¬å…³é”®å­— (keywords)
* [`item`](./minutiae/fragment-specifiers.md#item)ï¼šä¸€ä¸ªæ¡ç›®ï¼ˆæ¯”å¦‚å‡½æ•°ã€ç»“æ„ä½“ã€æ¨¡å—ã€`impl` å—ï¼‰
* [`lifetime`](./minutiae/fragment-specifiers.md#lifetime)ï¼šä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ³¨è§£ï¼ˆæ¯”å¦‚ `'foo`ã€`'static`ï¼‰
* [`literal`](./minutiae/fragment-specifiers.md#literal)ï¼šä¸€ä¸ªå­—é¢å€¼ï¼ˆæ¯”å¦‚ `"Hello World!"`ã€`3.14`ã€`'ğŸ¦€'`ï¼‰
* [`meta`](./minutiae/fragment-specifiers.md#meta)ï¼šä¸€ä¸ªå…ƒä¿¡æ¯ï¼ˆæ¯”å¦‚ `#[...]` å’Œ `#![...]` å±æ€§å†…éƒ¨çš„ä¸œè¥¿ï¼‰
* [`pat`](./minutiae/fragment-specifiers.md#pat)ï¼šä¸€ä¸ªæ¨¡å¼ (pattern)
* [`path`](./minutiae/fragment-specifiers.md#path)ï¼šä¸€æ¡è·¯å¾„ï¼ˆæ¯”å¦‚ `foo`ã€`::std::mem::replace`ã€`transmute::<_, int>`ï¼‰
* [`stmt`](./minutiae/fragment-specifiers.md#stmt)ï¼šä¸€æ¡è¯­å¥ (statement)
* [`tt`](./minutiae/fragment-specifiers.md#tt)ï¼šå•æ£µæ ‡è®°æ ‘
* [`ty`](./minutiae/fragment-specifiers.md#ty)ï¼šä¸€ä¸ªç±»å‹
* [`vis`](./minutiae/fragment-specifiers.md#vis)ï¼šä¸€ä¸ªå¯èƒ½ä¸ºç©ºçš„å¯è§†æ ‡è¯†ç¬¦ï¼ˆæ¯”å¦‚ `pub`ã€`pub(in crate)`ï¼‰

[fragment-specifier]: https://doc.rust-lang.org/nightly/reference/macros-by-example.html#metavariables

å…³äºç‰‡æ®µåˆ†ç±»ç¬¦æ›´æ·±å…¥çš„æè¿°è¯·é˜…è¯»æœ¬ä¹¦çš„[ç‰‡æ®µåˆ†ç±»ç¬¦](./minutiae/fragment-specifiers.md)ä¸€ç« ã€‚

æ¯”å¦‚ä»¥ä¸‹å£°æ˜å®æ•è·ä¸€ä¸ªè¡¨è¾¾å¼è¾“å…¥åˆ°å…ƒå˜é‡ `$e`ï¼š

```rust,ignore
macro_rules! one_expression {
    ($e:expr) => {...};
}
```

å…ƒå˜é‡å¯¹ Rust ç¼–è¯‘å™¨çš„è§£æå™¨äº§ç”Ÿå½±å“ï¼Œè€Œè§£æå™¨ä¹Ÿä¼šç¡®ä¿å…ƒå˜é‡æ€»æ˜¯è¢«â€œæ­£ç¡®æ— è¯¯â€åœ°è§£æã€‚

`expr` å…ƒå˜é‡æ€»æ˜¯æ•è·å®Œæ•´ä¸”ç¬¦åˆ Rust ç¼–è¯‘ç‰ˆæœ¬çš„è¡¨è¾¾å¼ã€‚

ä½ å¯ä»¥åœ¨æœ‰é™çš„æƒ…å†µä¸‹åŒæ—¶ç»“åˆå­—é¢ä¸Šçš„æ ‡è®°æ ‘å’Œå…ƒå˜é‡ã€‚ï¼ˆè§ [Metavariables and Expansion Redux] ä¸€èŠ‚ï¼‰

å½“å…ƒå˜é‡å·²ç»åœ¨ matcher ä¸­ç¡®å®šä¹‹åï¼Œä½ åªéœ€è¦å†™ `$name` å°±èƒ½å¼•ç”¨å…ƒå˜é‡ã€‚æ¯”å¦‚ï¼š

```rust,ignore
macro_rules! times_five {
    ($e:expr) => { 5 * $e };
}
```

å…ƒå˜é‡è¢«æ›¿æ¢æˆå®Œæ•´çš„ AST èŠ‚ç‚¹ï¼Œè¿™å¾ˆåƒå®å±•å¼€ã€‚è¿™ä¹Ÿæ„å‘³ç€è¢« `$e` 
æ•è·çš„ä»»ä½•æ ‡è®°åºåˆ—éƒ½ä¼šè¢«è§£ææˆå•ä¸ªå®Œæ•´çš„è¡¨è¾¾å¼ã€‚

ä½ ä¹Ÿå¯ä»¥ä¸€ä¸ª matcher ä¸­æ•è·å¤šä¸ªå…ƒå˜é‡ï¼š

```rust,ignore
macro_rules! multiply_add {
    ($a:expr, $b:expr, $c:expr) => { $a * ($b + $c) };
}
```

ç„¶ååœ¨ expansion ä¸­ä½¿ç”¨ä»»æ„æ¬¡æ•°çš„å…ƒå˜é‡ï¼š

```rust,ignore
macro_rules! discard {
    ($e:expr) => {};
}
macro_rules! repeat {
    ($e:expr) => { $e; $e; $e; };
}
```

æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å…ƒå˜é‡å«åš [`$crate`] ï¼Œå®ƒç”¨æ¥æŒ‡ä»£å½“å‰ crate ã€‚

[Metavariables and Expansion Redux]: ./minutiae/metavar-and-expansion.md
[`$crate`]: ./minutiae/hygiene.md#crate

## åå¤

matcher å¯ä»¥æœ‰åå¤æ•è· (repetition)ï¼Œè¿™ä½¿å¾—åŒ¹é…ä¸€è¿ä¸²æ ‡è®° (token)
æˆä¸ºå¯èƒ½ã€‚åå¤æ•è·çš„ä¸€èˆ¬å½¢å¼ä¸º `$ ( ... ) sep rep`ã€‚

* `$` æ˜¯å­—é¢ä¸Šçš„ç¾å…ƒç¬¦å·æ ‡è®°
* `( ... )` æ˜¯è¢«åå¤åŒ¹é…çš„æ¨¡å¼ï¼Œç”±å°æ‹¬å·åŒ…å›´ã€‚
* `sep` æ˜¯**å¯é€‰**çš„åˆ†éš”æ ‡è®°ã€‚å®ƒä¸èƒ½æ˜¯æ‹¬å·æˆ–è€…åå¤æ“ä½œç¬¦ `rep`ã€‚å¸¸ç”¨ä¾‹å­æœ‰ `,` å’Œ `;` ã€‚
* `rep` æ˜¯**å¿…é¡»**çš„é‡å¤æ“ä½œç¬¦ã€‚å½“å‰å¯ä»¥æ˜¯ï¼š
    * `?`ï¼šè¡¨ç¤ºæœ€å¤šä¸€æ¬¡é‡å¤ï¼Œæ‰€ä»¥æ­¤æ—¶ä¸èƒ½å‰è·Ÿåˆ†éš”æ ‡è®°ã€‚
    * `*`ï¼šè¡¨ç¤ºé›¶æ¬¡æˆ–å¤šæ¬¡é‡å¤ã€‚
    * `+`ï¼šè¡¨ç¤ºä¸€æ¬¡æˆ–å¤šæ¬¡é‡å¤ã€‚

åå¤æ•è·ä¸­å¯ä»¥åŒ…å«ä»»æ„å…¶ä»–çš„æœ‰æ•ˆ matcherï¼Œæ¯”å¦‚å­—é¢ä¸Šçš„æ ‡è®°æ ‘ã€å…ƒå˜é‡ä»¥åŠä»»æ„åµŒå¥—çš„åå¤æ•è·ã€‚

åœ¨ expansion ä¸­ï¼Œä½¿ç”¨è¢«åå¤æ•è·çš„å†…å®¹æ—¶ï¼Œä¹Ÿé‡‡ç”¨ç›¸åŒçš„è¯­æ³•ã€‚è€Œä¸”è¢«åå¤æ•è·çš„å…ƒå˜é‡åªèƒ½å­˜åœ¨äºåå¤è¯­æ³•å†…ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œä¸‹é¢è¿™ä¸ªå®å°†æ¯ä¸€ä¸ªå…ƒç´ è½¬æ¢æˆå­—ç¬¦ä¸²ï¼šå®ƒå…ˆåŒ¹é…é›¶æˆ–å¤šä¸ªç”±é€—å·åˆ†éš”çš„è¡¨è¾¾å¼ï¼Œå¹¶åˆ†åˆ«å°†å®ƒä»¬æ„é€ æˆ
`Vec` çš„è¡¨è¾¾å¼ã€‚

```rust,editable
macro_rules! vec_strs {
    (
        // å¼€å§‹åå¤æ•è·
        $(
            // æ¯ä¸ªåå¤å¿…é¡»åŒ…å«ä¸€ä¸ªè¡¨è¾¾å¼
            $element:expr
        )
        // ç”±é€—å·åˆ†éš”
        ,
        // 0 æˆ–å¤šæ¬¡
        *
    ) => {
        // åœ¨è¿™ä¸ªå—å†…ç”¨å¤§æ‹¬å·æ‹¬èµ·æ¥ï¼Œç„¶ååœ¨é‡Œé¢å†™å¤šæ¡è¯­å¥
        {
            let mut v = Vec::new();

            // å¼€å§‹åå¤æ•è·
            $(
                // æ¯ä¸ªåå¤ä¼šå±•å¼€æˆä¸‹é¢è¡¨è¾¾å¼ï¼Œå…¶ä¸­ $element è¢«æ¢æˆç›¸åº”è¢«æ•è·çš„è¡¨è¾¾å¼
                v.push(format!("{}", $element));
            )*

            v
        }
    };
}

fn main() {
    let s = vec_strs![1, "a", true, 3.14159f32];
    assert_eq!(s, &["1", "a", "true", "3.14159"]);
}
```

ä½ å¯ä»¥åœ¨ä¸€ä¸ªåå¤è¯­å¥é‡Œé¢ä½¿ç”¨å¤šæ¬¡å’Œå¤šä¸ªå…ƒå˜é‡ï¼Œåªè¦è¿™äº›å…ƒå˜é‡ä»¥ç›¸åŒçš„æ¬¡æ•°é‡å¤ã€‚æ‰€ä»¥ä¸‹é¢çš„å®ä»£ç æ­£å¸¸è¿è¡Œï¼š

```rust,editable
macro_rules! repeat_two {
    ($($i:ident)*, $($i2:ident)*) => {
        $( let $i: (); let $i2: (); )*
    }
}

fn main () {
    repeat_two!( a b c d e f, u v w x y z );
}
```

ä½†æ˜¯è¿™ä¸‹é¢çš„ä¸èƒ½è¿è¡Œï¼š

```rust,editable
# macro_rules! repeat_two {
#     ($($i:ident)*, $($i2:ident)*) => {
#         $( let $i: (); let $i2: (); )*
#     }
# }

fn main() {
    repeat_two!( a b c d e f, x y z );
}
```

è¿è¡ŒæŠ¥ä»¥ä¸‹é”™è¯¯ï¼š

```
error: meta-variable `i` repeats 6 times, but `i2` repeats 3 times
 --> src/main.rs:6:10
  |
6 |         $( let $i: (); let $i2: (); )*
  |          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
```

## å…ƒå˜é‡è¡¨è¾¾å¼

> *RFC*: [rfcs#1584](https://github.com/rust-lang/rfcs/blob/master/text/3086-macro-metavar-expr.md)
>
> *Tracking Issue*: [rust#83527](https://github.com/rust-lang/rust/issues/83527)
>
> *Feature*: `#![feature(macro_metavar_expr)]`

transcriber[^transcriber] å¯ä»¥åŒ…å«æ‰€è°“çš„å…ƒå˜é‡è¡¨è¾¾ (metavariable expressions)ã€‚

å…ƒå˜é‡è¡¨è¾¾å¼ä¸º transcriber æä¾›äº†å…³äºå…ƒå˜é‡çš„ä¿¡æ¯ â€”â€” è¿™äº›ä¿¡æ¯æ˜¯ä¸å®¹æ˜“è·å¾—çš„ã€‚

ç›®å‰é™¤äº† `$$` è¡¨è¾¾å¼å¤–ï¼Œå®ƒä»¬çš„ä¸€èˆ¬å½¢å¼éƒ½æ˜¯ `$ { op(...) }`ï¼šå³é™¤äº† `$$` ä»¥å¤–çš„æ‰€æœ‰å…ƒå˜é‡è¡¨è¾¾å¼éƒ½æ¶‰åŠåå¤ã€‚

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¡¨è¾¾å¼ï¼ˆå…¶ä¸­ `ident` æ˜¯æ‰€ç»‘å®šçš„å…ƒå˜é‡çš„åç§°ï¼Œè€Œ `depth` æ˜¯æ•´å‹å­—é¢å€¼ï¼‰ï¼š

* `${count(ident)}`ï¼šæœ€é‡Œå±‚åå¤ `$ident` çš„æ€»æ¬¡æ•°ï¼Œç›¸å½“äº `${count(ident, 0)}`
* `${count(identï¼Œdepth)}`ï¼šç¬¬ `depth` å±‚åå¤ `$ident` çš„æ¬¡æ•°
* `${index()}`ï¼šæœ€é‡Œå±‚åå¤çš„å½“å‰åå¤çš„ç´¢å¼•ï¼Œç›¸å½“äº `${index(0)}`
* `${index(depth)}`ï¼šåœ¨ç¬¬ `depth` å±‚å¤„å½“å‰åå¤çš„ç´¢å¼•ï¼Œå‘å¤–è®¡æ•°
* `${length()}`ï¼šæœ€é‡Œå±‚åå¤çš„é‡å¤æ¬¡æ•°ï¼Œç›¸å½“äº `${length(0)}`
* `${length(depth)}`ï¼šåœ¨ç¬¬ `depth` å±‚åå¤çš„æ¬¡æ•°ï¼Œå‘å¤–è®¡æ•°
* `${ignore(ident)}`ï¼šç»‘å®š `$ident` è¿›è¡Œé‡å¤ï¼Œå¹¶å±•å¼€æˆç©º
* `$$`ï¼šå±•å¼€ä¸ºå•ä¸ª `$`ï¼Œè¿™ä¼šæœ‰æ•ˆåœ°è½¬ä¹‰ `$` æ ‡è®°ï¼Œå› æ­¤å®ƒä¸ä¼šè¢«å±•å¼€ï¼ˆè½¬å†™ï¼‰

[^transcriber]: å³ expansionï¼ŒæŒ‡å±•å¼€çš„éƒ¨åˆ†ï¼Œæ˜¯æ¯æ¡å£°æ˜å®è§„åˆ™çš„ååŠæ®µã€‚

---

&nbsp;

æƒ³äº†è§£å®Œæ•´çš„å®šä¹‰è¯­æ³•ï¼Œå¯ä»¥å‚è€ƒ Rust Reference ä¹¦çš„ [Macros By Example][mbe] ä¸€ç« ã€‚

